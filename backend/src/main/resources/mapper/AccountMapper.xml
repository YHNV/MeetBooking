<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- <mapper namespace="com.example.mapper.UserMapper"> -->

<mapper namespace="com.zb.backend.mapper.AccountMapper">
    <!-- Account实体类与accounts表的字段映射 -->
    <resultMap id="AccountResultMap" type="com.zb.backend.entity.Account">
        <result property="accountId" column="account_id"/>
        <result property="password" column="password"/>
        <result property="isAdmin" column="is_admin"/>
        <result property="isActive" column="is_active"/>
        <result property="firstLogin" column="first_login"/>
        <result property="lastLoginTime" column="last_login_time"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>
    <insert id="insertAccount">
        insert into ACCOUNTS (PASSWORD)
        values (#{password});
    </insert>
    <update id="updateLastLoginTime">
        update ACCOUNTS set LAST_LOGIN_TIME = CURRENT_TIMESTAMP where ACCOUNT_ID = #{accountId}
    </update>
    <update id="updateAccountStatus">
        update ACCOUNTS
        set IS_ACTIVE = NOT IS_ACTIVE
        where ACCOUNT_ID = #{accountId};
    </update>
    <update id="updatePasswordByAccountId">
        update ACCOUNTS
        set PASSWORD = #{password}
        where ACCOUNT_ID = #{accountId};
    </update>
    <!-- 根据账号ID获取账号信息 -->
    <select id="selectAccountByAccountId" resultType="com.zb.backend.entity.Account">
        select account_id, password, is_admin, is_active, first_login, last_login_time, create_time, update_time
        from ACCOUNTS where ACCOUNT_ID = #{accountId}
    </select>
    <select id="selectEmpLoginInfoByAccountId" resultType="com.zb.backend.model.response.LoginResponse">
        SELECT
            -- 账号表字段
            a.account_id      AS accountId,
            a.is_admin        AS isAdmin,
            a.first_login     AS firstLogin,
            a.last_login_time AS lastLoginTime,
            -- 员工表字段
            e.emp_id          AS empId,
            e.emp_name        AS empName,
            e.position        AS position,
            e.phone           AS phone,
            e.email           AS email,
            e.is_manager      AS isManager,
            e.dept_id         AS deptId,
            -- 部门表字段
            d.dept_name       AS deptName
        FROM
            accounts a
                -- 关联员工表（账号ID=员工ID，一对一强制关联）
                INNER JOIN employees e ON a.account_id = e.emp_id
                -- 关联部门表（员工所属部门，强制关联）
                INNER JOIN departments d ON e.dept_id = d.dept_id
        -- 查询条件：账号ID
        WHERE
            a.account_id = #{accountId}
    </select>
    <select id="selectAdminLoginInfoByAccountId" resultType="com.zb.backend.model.response.LoginResponse">
        SELECT
            account_id AS accountId,
            is_admin AS isAdmin,
            -- 管理员默认不是经理（根据业务可调整）
            -- FALSE AS isManager,
            first_login AS firstLogin,
            last_login_time AS lastLoginTime
        FROM accounts
        WHERE account_id = #{accountId}
          AND is_admin = TRUE  -- 确保只查询管理员账号
          -- AND is_active = TRUE -- 只查询启用状态的账号
    </select>
    <select id="isAdminByAccountId" resultType="java.lang.Boolean">
        select IS_ADMIN
        from ACCOUNTS
        where ACCOUNT_ID = #{accountId};
    </select>
    <select id="selectAdminDetailByAccountId" resultType="com.zb.backend.model.response.AccountDetailResponse">
        SELECT
            a.account_id AS accountId,
            a.is_admin AS isAdmin,
            a.is_active AS isActive,
            a.first_login AS firstLogin,
            a.last_login_time AS lastLoginTime,
            a.create_time AS createTime,
            a.update_time AS updateTime
        FROM accounts a
        WHERE a.account_id = #{accountId}
          AND a.is_admin = true
    </select>
    <select id="selectEmpDetailAccountId" resultType="com.zb.backend.model.response.AccountDetailResponse">
        SELECT a.account_id      as accountId,
               a.is_admin        as isAdmin,
               a.is_active       as isActive,
               a.first_login     as firstLogin,
               a.last_login_time as lastLoginTime,
               a.create_time     as createTime,
               a.update_time     as updateTime,
               e.emp_id          as empId,
               e.emp_name        as empName,
               e.position        as position,
               e.phone           as phone,
               e.email           as email,
               e.id_card         as idCard,
               e.is_manager      as isManager,
               d.dept_id         as deptId,
               d.dept_name       as deptName,
               d.manager_id      as managerId,
               d.dept_address    as deptAddress,
               d.dept_desc       as deptDesc
        FROM accounts a
                 INNER JOIN employees e ON a.account_id = e.emp_id
                 INNER JOIN departments d ON e.dept_id = d.dept_id
        WHERE a.account_id = #{accountId}
          AND a.is_admin = false
    </select>
</mapper>