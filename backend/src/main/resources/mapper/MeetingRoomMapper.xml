<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- <mapper namespace="com.example.mapper.UserMapper"> -->

<mapper namespace="com.zb.backend.mapper.MeetingRoomMapper">
    <!-- MeetingRoom实体类与meeting_rooms表的字段映射 -->
    <resultMap id="MeetingRoomResultMap" type="com.zb.backend.entity.MeetingRoom">
        <result property="roomId" column="room_id"/>
        <result property="roomName" column="room_name"/>
        <result property="roomType" column="room_type"/>
        <result property="capacity" column="capacity"/>
        <result property="location" column="location"/>
        <result property="roomStatus" column="room_status"/>
        <result property="imageUrl" column="image_url"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>
    <insert id="insertMeetingRoom">
        insert into MEETING_ROOMS (ROOM_NAME, ROOM_TYPE, CAPACITY, LOCATION, ROOM_STATUS, IMAGE_URL)
        values (#{roomName}, #{roomType}, #{capacity}, #{location}, #{roomStatus}, #{imageUrl});
    </insert>
    <select id="selectMeetingRoomByRoomName" resultType="com.zb.backend.entity.MeetingRoom">
        select room_id, room_name, room_type, capacity, location, room_status, image_url, create_time, update_time
        from MEETING_ROOMS
        where ROOM_NAME = #{roomName};
    </select>
    <select id="countMeetingRoomList" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT mr.room_id)
        FROM meeting_rooms mr
        WHERE 1=1
        <if test="roomName != null and roomName != ''">
            AND mr.room_name LIKE CONCAT('%', #{roomName}, '%')
        </if>
        <if test="roomType != null and roomType != ''">
            AND mr.room_type = #{roomType}
        </if>
        <if test="minCapacity != null">
            AND mr.capacity &gt;= #{minCapacity}
        </if>
        <if test="maxCapacity != null">
            AND mr.capacity &lt;= #{maxCapacity}
        </if>
        <if test="location != null and location != ''">
            AND mr.location LIKE CONCAT('%', #{location}, '%')
        </if>
        <if test="roomStatus != null and roomStatus != ''">
            AND mr.room_status = #{roomStatus}
        </if>
        <if test="equipmentIdList != null and equipmentIdList.size() &gt; 0">
            <!-- 对每个设备ID添加AND EXISTS条件 -->
            <foreach collection="equipmentIdList" item="eqId" separator="">
                AND EXISTS (
                SELECT 1 FROM room_equipment re
                WHERE re.room_id = mr.room_id
                AND re.equipment_id = #{eqId}
                )
            </foreach>
        </if>
    </select>
    <select id="selectMeetingRoomList" resultType="com.zb.backend.entity.MeetingRoom">
        SELECT
        room_id,
        room_name,
        room_type,
        capacity,
        location,
        room_status,
        image_url,
        create_time,
        update_time
        FROM meeting_rooms mr
        WHERE 1=1
        <if test="roomName != null and roomName != ''">
            AND mr.room_name LIKE CONCAT('%', #{roomName}, '%')
        </if>
        <if test="roomType != null and roomType != ''">
            AND mr.room_type = #{roomType}
        </if>
        <if test="minCapacity != null">
            AND mr.capacity &gt;= #{minCapacity}
        </if>
        <if test="maxCapacity != null">
            AND mr.capacity &lt;= #{maxCapacity}
        </if>
        <if test="location != null and location != ''">
            AND mr.location LIKE CONCAT('%', #{location}, '%')
        </if>
        <if test="roomStatus != null and roomStatus != ''">
            AND mr.room_status = #{roomStatus}
        </if>
        <if test="equipmentIdList != null and equipmentIdList.size() &gt; 0">
            <!-- 对每个设备ID添加AND EXISTS条件 -->
            <foreach collection="equipmentIdList" item="eqId" separator="">
                AND EXISTS (
                SELECT 1 FROM room_equipment re
                WHERE re.room_id = mr.room_id
                AND re.equipment_id = #{eqId}
                )
            </foreach>
        </if>
        ORDER BY mr.room_id
        <!-- 分页 -->
        LIMIT ${(pageNum - 1) * pageSize}, #{pageSize}
    </select>
    <select id="selectMeetingRoomByRoomId" resultType="com.zb.backend.entity.MeetingRoom">
        select room_id, room_name, room_type, capacity, location, room_status, image_url, create_time, update_time
        from MEETING_ROOMS
        where ROOM_ID = #{roomId};
    </select>
    <select id="selectEquipmentListByRoomId" resultType="com.zb.backend.entity.Equipment">
        SELECT
            e.equipment_id,
            e.equipment_name,
            e.description,
            e.create_time,
            e.update_time
        FROM equipment e
                 INNER JOIN room_equipment re ON e.equipment_id = re.equipment_id
        WHERE re.room_id = #{roomId}
    </select>

</mapper>