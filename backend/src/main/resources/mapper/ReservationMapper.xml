<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- <mapper namespace="com.example.mapper.UserMapper"> -->

<mapper namespace="com.zb.backend.mapper.ReservationMapper">
    <!-- Reservation实体类与reservations表的字段映射 -->
    <resultMap id="ReservationResultMap" type="com.zb.backend.entity.Reservation">
        <result property="reservationId" column="reservation_id"/>
        <result property="roomId" column="room_id"/>
        <result property="accountId" column="account_id"/>
        <result property="empName" column="emp_name"/>
        <result property="meetingTopic" column="meeting_topic"/>
        <result property="meetingDesc" column="meeting_desc"/>
        <result property="reservationDate" column="reservation_date"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="reservationStatus" column="reservation_status"/>
        <result property="approvalAccountId" column="approval_account_id"/>
        <result property="approvalTime" column="approval_time"/>
        <result property="rejectReason" column="reject_reason"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>
    <insert id="insertReservation">
        <!-- 使用H2数据库的序列生成主键 -->
        <selectKey keyProperty="reservationId" resultType="java.lang.Long" order="BEFORE">
            SELECT NEXTVAL('reservation_seq')
        </selectKey>
        insert into RESERVATIONS
            (reservation_id, room_id, account_id, emp_name, meeting_topic, meeting_desc, reservation_date, start_time, end_time)
        values
            (#{reservationId}, #{reservationRequest.roomId}, #{accountId}, #{empName},
            #{reservationRequest.meetingTopic}, #{reservationRequest.meetingDesc},
            #{reservationRequest.reservationDate}, #{reservationRequest.startTime}, #{reservationRequest.endTime});
    </insert>
    <update id="updateReservation">
        UPDATE reservations
        SET
        reservation_status = #{reservationStatus},
        approval_account_id = #{approvalAccountId},
        approval_time = CURRENT_TIMESTAMP()
        <if test="rejectReason != null and rejectReason != ''">
            , reject_reason = #{rejectReason}
        </if>
        WHERE
        reservation_id = #{reservationId}
    </update>
    <update id="updateExpiredById">
        update RESERVATIONS
        set RESERVATION_STATUS = 'EXPIRED', APPROVAL_ACCOUNT_ID = 101
        where RESERVATION_ID = #{reservationId};
    </update>
    <select id="selectReservation" resultType="com.zb.backend.entity.Reservation">
        select *
        from RESERVATIONS
        where ROOM_ID = #{roomId} and ACCOUNT_ID = #{accountId} and RESERVATION_DATE = #{reservationDate} and START_TIME = #{startTime} and END_TIME = #{endTime} and RESERVATION_STATUS = 'PENDING';
    </select>
    <select id="countReservationList" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM reservations
        <where>
            <if test="accountId != null">
                AND account_id = #{accountId}
            </if>
            <if test="reservationDate != null">
                AND reservation_date = #{reservationDate}
            </if>
            <if test="reservationStatus != null and reservationStatus != ''">
                AND reservation_status = #{reservationStatus}
            </if>
        </where>
    </select>
    <select id="selectReservationList" resultType="com.zb.backend.entity.Reservation">
        SELECT
        reservation_id,
        room_id,
        account_id,
        emp_name,
        meeting_topic,
        meeting_desc,
        reservation_date,
        start_time,
        end_time,
        reservation_status,
        approval_account_id,
        approval_time,
        reject_reason,
        create_time,
        update_time
        FROM reservations
        <where>
            <if test="accountId != null">
                AND account_id = #{accountId}
            </if>
            <if test="reservationDate != null">
                AND reservation_date = #{reservationDate}
            </if>
            <if test="reservationStatus != null and reservationStatus != ''">
                AND reservation_status = #{reservationStatus}
            </if>
        </where>
        ORDER BY create_time DESC
        <!-- 分页处理：计算偏移量 -->
        LIMIT ${(pageNum - 1) * pageSize}, #{pageSize}
    </select>
    <select id="selectReservationById" resultType="com.zb.backend.entity.Reservation">
        select reservation_id, room_id, account_id, emp_name, meeting_topic, meeting_desc, reservation_date, start_time, end_time, reservation_status, approval_account_id, approval_time, reject_reason, create_time, update_time
        from RESERVATIONS
        where RESERVATION_ID = #{reservationId};
    </select>
    <select id="selectAbleRerByRoomId" resultType="com.zb.backend.entity.Reservation">
        select reservation_id, room_id, account_id, emp_name, meeting_topic, meeting_desc, reservation_date, start_time, end_time, reservation_status, approval_account_id, approval_time, reject_reason, create_time, update_time
        from RESERVATIONS
        where ROOM_ID = #{roomId}
        and RESERVATION_STATUS in ('PENDING', 'APPROVED');
    </select>
    <select id="selectNotExpiredByDate" resultType="com.zb.backend.entity.Reservation">
        SELECT
        reservation_id,
        room_id,
        account_id,
        emp_name,
        meeting_topic,
        meeting_desc,
        reservation_date,
        start_time,
        end_time,
        reservation_status,
        approval_account_id,
        approval_time,
        reject_reason,
        create_time,
        update_time
        FROM reservations
        WHERE
        -- 预约日期 小于等于 当前日期（包含当天）
        reservation_date &lt;= #{currentDate}
        -- 预约状态不等于过期
        AND reservation_status != 'EXPIRED'
        -- 可选：按预约日期和开始时间排序
        ORDER BY RESERVATION_ID
    </select>
</mapper>